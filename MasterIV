# IV
# first stage diff and diff

# load packages


install.packages("ggplot2")
library(ggplot2)

install.packages("foreign")
library(foreign)
 


install.packages("car")
library(car)
install.packages('ivpack')
library('ivpack')

library(sandwich)


install.packages("ivmodel")
library(ivmodel)

install.packages("stargazer")
library(stargazer)

# clear the global workspace
rm(list=ls())



# set working directory (only works on my computer)
# uncomment this before running the codes
setwd("/Users/apple/Documents/LSE 3RD YEAR/EC331/data/MasterIV")

# load data
CHIP <- read.dta("CHIPIVnew.dta")

# omit missing values
CHIP <- na.omit(CHIP)

CHIP$parent_birthyear <- 2002 - CHIP$parent_age

# check parallel trend for diff and diff
# subset poor and not poor group based on father of parent (hereafter denoted as GF for grandfather)'s social status (Chengfen in Chinese); 
# 1 denotes poor peasants, the rest index denotes all other classifications.
poor <- CHIP[CHIP$GFchengfen == 1,]
notpoor <- CHIP[CHIP$GFchengfen != 1, ]

# aggregate mean years of schooling for each birth year 
aggrpoor <- aggregate(poor$parent_schooling,by = list(poor$parent_birthyear),mean,na.rm=TRUE)
aggrpoor$type <- "poor peasants"

aggrnotpoor <- aggregate(notpoor$parent_schooling,by = list(notpoor$parent_birthyear),mean,na.rm=TRUE)
aggrnotpoor$type <- "lower middle and above"

aggr <- rbind(aggrpoor,aggrnotpoor)

# plot mean schooling years for the two groups
plot <- ggplot(aggr, aes(Group.1,x,colour=type)) + xlim(1920,1960) + xlab("birth year") + ylab("mean schooling years") + geom_line() 
plot1 <- plot + geom_vline(xintercept=1938) + geom_vline(xintercept=1954) +  theme_bw() + theme(legend.position = "bottom") + scale_color_manual(values=c("navyblue", "brown")) + theme(text=element_text(size=12)) +  theme(legend.text=element_text(size=12))
plot1 
#ggsave("parallel trend check.pdf",plot1)


# first stage 
# create dummy for poor households
CHIP$poor <- as.numeric(CHIP$GFchengfen == 1)

# create dummy variable treated
# treated cohort: 1938-1954; controlled cohort: before 1938

attach(CHIP)
CHIP$treated[CHIP$parent_birthyear>=1938 & CHIP$parent_birthyear <= 1954] <- 1
CHIP$treated[CHIP$parent_birthyear<=1937] <- 0
detach(CHIP)

# create an interaction term for treated and poor
CHIP$TreatedPoor <- CHIP$treated * CHIP$poor
CHIP$BirthyearPoor <- CHIP$parent_birthyear * CHIP$poor
CHIP$GFchengfen <- as.factor(CHIP$GFchengfen)

CHIP$parent_age <- as.factor(CHIP$parent_age)
CHIP$AgePoor<- CHIP$parent_age* CHIP$poor

#subset mother-all, mother-daughter, mother-son, father-all, father-daughter, father-son pairs
Mother <- CHIP[(CHIP$parent_female == 1),]
Father <- CHIP[(CHIP$parent_female == 0),]
MotherD <- Mother[Mother$child_female == 1,]
MotherS <- Mother[Mother$child_female==0,]
FatherD <- Father[Father$child_female == 1,]
FatherS <- Father[Father$child_female == 0,]

# first stage diff in diff output
# all-all
first_stage_aa <- lm(parent_schooling ~ poor + treated + TreatedPoor + child_age + parent_female + parent_age + child_female + PROVINCE + GFeduc + GFage , data = CHIP)
summary(first_stage_aa)

# mother-all
first_stage_ma <- lm(parent_schooling ~ treated + poor + TreatedPoor + parent_age + child_age  + PROVINCE + GFage + GFeduc, data = Mother)
summary(first_stage_ma,vcov=sandwich)
linearHypothesis(first_stage_ma, c("treated = poor","poor = TreatedPoor"),vcov=sandwich)

# output with robust standard errors
robust.se.first_stage_ma <- sqrt(diag(vcovHC(first_stage_ma, type = "HC")))
stargazer(first_stage_ma,se=list(robust.se.first_stage_ma))

# mother-daughter
first_stage_md <- lm(parent_schooling ~   GFchengfen + TreatedPoor + child_age + parent_age +  PROVINCE + GFage + GFeduc, data = MotherD)
summary(first_stage_md)
linearHypothesis(first_stage_md, c("treated = poor","poor = TreatedPoor"),vcov=sandwich)

# output with robust standard errors
robust.se.first_stage_md <- sqrt(diag(vcovHC(first_stage_md, type = "HC")))
stargazer(first_stage_md,se=list(robust.se.first_stage_md))

# mother-son
first_stage_ms <- lm(parent_schooling ~ GFchengfen + TreatedPoor + child_age + parent_age +  PROVINCE + GFage + GFeduc, data = MotherS)
summary(first_stage_ms)
linearHypothesis(first_stage_ms, c("treated = poor","poor = TreatedPoor"),vcov=sandwich)


# output with robust standard errors
robust.se.first_stage_ms <- sqrt(diag(vcovHC(first_stage_ms, type = "HC")))
stargazer(first_stage_ms,se=list(robust.se.first_stage_ms))

#father-all
first_stage_fa <- lm(parent_schooling ~ poor + child_age + parent_age +  AgePoor + PROVINCE + GFage + GFeduc, data = Father)
summary(first_stage_fa)
linearHypothesis(first_stage_fa, c("treated = poor","poor = TreatedPoor"),vcov=sandwich)

# output with robust standard errors
robust.se.first_stage_fa <- sqrt(diag(vcovHC(first_stage_fa, type = "HC")))
stargazer(first_stage_fa,se=list(robust.se.first_stage_fa))

# father-daughter
first_stage_fd <- lm(parent_schooling ~ treated + poor + TreatedPoor + child_age + parent_age +  PROVINCE + GFage + GFeduc, data = FatherD)
summary(first_stage_fd)
linearHypothesis(first_stage_fd, c("treated = poor","poor = TreatedPoor"),vcov=sandwich)

# output with robust standard errors
robust.se.first_stage_fd <- sqrt(diag(vcovHC(first_stage_fd, type = "HC")))
stargazer(first_stage_fd,se=list(robust.se.first_stage_fd))

# father-son
first_stage_fs <- lm(parent_schooling ~ GFchengfen + TreatedPoor + child_age +  parent_age + PROVINCE + GFage + GFeduc, data = FatherS)
summary(first_stage_fs)
linearHypothesis(first_stage_fs, c("treated = poor","poor = TreatedPoor"),vcov=sandwich)

# output with robust standard errors
robust.se.first_stage_fs <- sqrt(diag(vcovHC(first_stage_fs, type = "HC")))
stargazer(first_stage_fs,se=list(robust.se.first_stage_fs))


# iv regression
# I use Treated, Poor and the interaction term TreatedPoor as intrusments for the endogenous variable parent_schooling
# all-all
iv_reg_aa <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + poor + treated + PROVINCE + GFage + GFeduc | . - parent_schooling + TreatedPoor,  data = CHIP)
summary(iv_reg_aa)

iv_reg_aa <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + poor + treated + PROVINCE  | . - parent_schooling + TreatedPoor,  data = CHIP)
summary(iv_reg_aa)

robust.se.aa <- sqrt(diag(vcovHC(iv_reg_aa, type = "HC")))
stargazer(iv_reg_aa, se = list(robust.se.aa),  diagnostics = TRUE)


# mother-all
iv_reg_ma <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + treated + poor + PROVINCE + GFage + GFeduc | . - parent_schooling + TreatedPoor,  data = Mother)
summary(iv_reg_ma)

iv_reg_ma <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + treated + poor  + GFage + GFeduc | . - parent_schooling + TreatedPoor,  data = Mother)
summary(iv_reg_ma)


, vcov = sandwich, diagnostics = TRUE
robust.se.ma <- sqrt(diag(vcovHC(iv_reg_ma, type = "HC")))
stargazer(iv_reg_ma, se = list(robust.se.ma),  diagnostics = TRUE)

anderson.rubin.ci(iv_reg_ma)


# mother-daughter
iv_reg_md <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + treated + poor + PROVINCE + GFage + GFeduc | . - parent_schooling + TreatedPoor,  data = MotherD)
summary(iv_reg_md)


iv_reg_md <- ivreg(child_schooling ~ parent_schooling + child_age  poor + parent_age + PROVINCE + GFage + GFeduc |TreatedPoor + treated + poor + child_age + parent_age + PROVINCE + GFeduc + GFage, data = MotherD,x=TRUE)
summary(iv_reg_md, vcov = sandwich, diagnostics = TRUE)
robust.se.md <- sqrt(diag(vcovHC(iv_reg_md, type = "HC")))
stargazer(iv_reg_md, se = list(robust.se.md))

anderson.rubin.ci(iv_reg_md)


# mother-son
iv_reg_ms <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + treated + poor + PROVINCE + GFage + GFeduc | . - parent_schooling + TreatedPoor,  data = MotherS)
summary(iv_reg_ms)




iv_reg_ms <- ivreg(child_schooling ~ parent_schooling + child_age + treated + poor + parent_age +  PROVINCE +  GFage + GFeduc |TreatedPoor+ treated + poor + child_age + parent_age + PROVINCE +  GFage + GFeduc , data = MotherS)
summary(iv_reg_ms, vcov = sandwich,  diagnostics = TRUE)
robust.se.ms <- sqrt(diag(vcovHC(iv_reg_ms, type = "HC")))
stargazer(iv_reg_ms, se = list(robust.se.ms))


# father-all
iv_reg_fa <- ivreg(child_schooling ~ parent_schooling + parent_age + child_age + treated + poor + PROVINCE + GFage + GFeduc | . - parent_schooling + TreatedPoor,  data = Father)
summary(iv_reg_fa)




iv_reg_fa <- ivreg(child_schooling ~ parent_schooling + child_age + treated + poor + parent_age +  PROVINCE +  GFage + GFeduc |.-parent_schooling + TreatedPoor, data = Father)
summary(iv_reg_fa)
        , vcov = sandwich,  diagnostics = TRUE)
robust.se.fa <- sqrt(diag(vcovHC(iv_reg_fa, type = "HC")))
stargazer(iv_reg_fa, se = list(robust.se.fa))


# father-daughter
iv_reg_fd <- ivreg(child_schooling ~ parent_schooling + child_age + parent_age +   PROVINCE +  GFage + GFeduc  |TreatedPoor + treated + poor + child_age  + parent_age + PROVINCE +  GFage + GFeduc, data = FatherD)
summary(iv_reg_fd, vcov = sandwich,  diagnostics = TRUE)
robust.se.fd <- sqrt(diag(vcovHC(iv_reg_fd, type = "HC")))
stargazer(iv_reg_fd, se = list(robust.se.fd))


# father-son
iv_reg_fs <- ivreg(child_schooling ~ parent_schooling + child_age + parent_age +  PROVINCE +  GFage + GFeduc  |TreatedPoor + treated + poor + child_age + parent_age + PROVINCE +  GFage + GFeduc, data = FatherS)
summary(iv_reg_fs, vcov = sandwich,  diagnostics = TRUE)
robust.se.fs <- sqrt(diag(vcovHC(iv_reg_fs, type = "HC")))
stargazer(iv_reg_fs, se = list(robust.se.fs))


#OLS
#mother all
ols_ma <- lm(child_schooling ~ parent_schooling + child_female + child_age + parent_age + poor + treated + PROVINCE +  GFage + GFeduc,  data = Mother)
summary(ols_ma, vcov = sandwich)
robust.se.ols.ma <- sqrt(diag(vcovHC(ols_ma, type = "HC")))
stargazer(ols_ma, se = list(robust.se.ols.ma))

#mother daughter
ols_md <- lm(child_schooling ~ parent_schooling + child_age + parent_age + PROVINCE +  GFage + GFeduc,  data = MotherD)
summary(ols_md, vcov = sandwich)
robust.se.ols.md <- sqrt(diag(vcovHC(ols_md, type = "HC")))
stargazer(ols_md, se = list(robust.se.ols.md))


#mother son
ols_ms <- lm(child_schooling ~ parent_schooling + child_age + parent_age + PROVINCE +  GFage + GFeduc,  data = MotherS)
summary(ols_ms, vcov = sandwich)
robust.se.ols.ms <- sqrt(diag(vcovHC(ols_ms, type = "HC")))
stargazer(ols_ms, se = list(robust.se.ols.ms))


#father all
ols_fa <- lm(child_schooling ~ parent_schooling + child_age + parent_age + PROVINCE +  GFage + GFeduc,  data = Father)
summary(ols_fa, vcov = sandwich)
robust.se.ols.fa <- sqrt(diag(vcovHC(ols_fa, type = "HC")))
stargazer(ols_fa, se = list(robust.se.ols.fa))

#father daughter
ols_fd <- lm(child_schooling ~ parent_schooling + child_age + parent_age + PROVINCE +  GFage + GFeduc,  data = FatherD)
summary(ols_fd, vcov = sandwich)
robust.se.ols.fd <- sqrt(diag(vcovHC(ols_fd, type = "HC")))
stargazer(ols_fd, se = list(robust.se.ols.fd))

#father son
ols_fs <- lm(child_schooling ~ parent_schooling + child_age + parent_age + PROVINCE +  GFage + GFeduc,  data = FatherS)
summary(ols_fs, vcov = sandwich)
robust.se.ols.fs <- sqrt(diag(vcovHC(ols_fs, type = "HC")))
stargazer(ols_fs, se = list(robust.se.ols.fs))


# LIML
#mother all
Y=Mother[,"child_schooling"]
D=Mother[,"parent_schooling"]
Z=Mother[,c("treated","poor","TreatedPoor")]
controls = c( "child_age","parent_age","PROVINCE","GFage","GFeduc")
X=Mother[,controls]
iv_reg_ma = ivmodel(Y=Y,D=D,Z=Z,X=X)
LIML(iv_reg_ma,alpha=0.01)

#mother daughter
Y=MotherD[,"child_schooling"]
D=MotherD[,"parent_schooling"]
Z=MotherD[,c("treated","poor","TreatedPoor")]
controls = c( "child_age","parent_age","PROVINCE","GFage","GFeduc")
X=MotherD[,controls]
iv_reg_md = ivmodel(Y=Y,D=D,Z=Z,X=X)
LIML(iv_reg_md,alpha=0.01)

#mother son
Y=MotherS[,"child_schooling"]
D=MotherS[,"parent_schooling"]
Z=MotherS[,c("treated","poor","TreatedPoor")]
controls = c( "child_age","parent_age","PROVINCE","GFage","GFeduc")
X=MotherS[,controls]
iv_reg_ms = ivmodel(Y=Y,D=D,Z=Z,X=X)
LIML(iv_reg_ms,alpha=0.01)

#father all
Y=Father[,"child_schooling"]
D=Father[,"parent_schooling"]
Z=Father[,c("treated","poor","TreatedPoor")]
controls = c( "child_age","parent_age","PROVINCE","GFage","GFeduc")
X=Father[,controls]
iv_reg_fa = ivmodel(Y=Y,D=D,Z=Z,X=X)
LIML(iv_reg_fa,alpha=0.01)


#father all
Y=FatherD[,"child_schooling"]
D=FatherD[,"parent_schooling"]
Z=FatherD[,c("treated","poor","TreatedPoor")]
controls = c( "child_age","parent_age","PROVINCE","GFage","GFeduc")
X=FatherD[,controls]
iv_reg_fd = ivmodel(Y=Y,D=D,Z=Z,X=X)
LIML(iv_reg_fd,alpha=0.01)
