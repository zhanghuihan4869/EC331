###Output my data set###
#Huihan Zhang

# Load and install packages, note the new packages
installation_needed  <- TRUE
loading_needed <- TRUE
package_list <- c('foreign', 'xtable', 'plm','gmm', 'AER','stargazer','readstata13', 'ggplot2',
                  'boot', 'arm', 'lmtest', 'sem', 'bdynsys', 'ivpack', 'mfx', 'glm2','plyr')
if(installation_needed){install.packages(package_list, repos='http://cran.us.r-project.org')}
if(loading_needed){lapply(package_list, require, character.only = TRUE)}

# clear the global workspace
rm(list=ls())

# set working directory (only works on my computer)
# uncomment this before running the codes
setwd("/Users/apple/Documents/LSE 3RD YEAR/EC331/data/MasterData")

# load raw data -- Chinese Household Income Project urban survey 2002
# downloaded from "https://www.icpsr.umich.edu/icpsrweb/ICPSR/series/243"
mydata <- read.dta13("/Users/apple/Documents/LSE 3RD YEAR/EC331/data/Raw Data.dta") 

# select variables of interest
mydata <- mydata[c("CITY","PCODE","CODE_P","P103","P104","P105","P106","P108","P113","PROVINCE")]

# rename variables 
mydata <- rename(mydata, c("PCODE"="HHID","CODE_P"="INDID","P103"="relationship", "P104"="hukou", "P105"="female", "P106"="age", "P108"="ethnicity", "P113"="schooling"))

# I'm going to restrict my data to age >= 22, so that most of them have completed university education
mydata <- mydata[mydata$age >= 22,]

# recode categorical variables to numeric factors
mydata$female <- ifelse(mydata$female == "male", 0, ifelse(mydata$female == "female", 1, NA))
#mydata$hukou <- ifelse(mydata$hukou == "Urban Hukou of the resident city (county)", 0, ifelse(mydata$hukou == "Rural Hukou of other city (or county)", 1, NA))
mydata$minority <- as.numeric(mydata$minority == 2)

# generate helper variables to identify mother, father, child and child's gender 
mydata$mother <- as.numeric((mydata$relationship == "Self"|mydata$relationship == "Spouse") & mydata$female == 1)
mydata$father <- as.numeric((mydata$relationship == "Self"|mydata$relationship == "Spouse") & mydata$female == 0)
mydata$child <- as.numeric(mydata$relationship == "Child") 
mydata$child_female <- as.numeric(mydata$female == 1 & mydata$child == 1)

# generate helper variables to identify mother's age, father's age, and child's age 
for (i in 1:nrow(mydata))
{if(mydata$child[i] & is.na(mydata$female[i]) == FALSE)
  {mydata[i,"child_age"] <- mydata$age[i]}
  else {mydata[i, "child_age"] <- NA}}

for (i in 1:nrow(mydata))
{if(mydata$mother[i] & is.na(mydata$female[i]) == FALSE)
  {mydata[i,"mother_age"] <- mydata$age[i]}
  else {mydata[i, "mother_age"] <- NA}}

for (i in 1:nrow(mydata))
{if(mydata$father[i] & is.na(mydata$female[i]) == FALSE)
  {mydata[i,"father_age"] <- mydata$age[i]}
  else {mydata[i, "father_age"] <- NA}}

# generate helper variables to identify mother's schooling, father's schooling, and child's schooling
for (i in 1:nrow(mydata))
{if(mydata$mother[i] & is.na(mydata$female[i]) == FALSE)
  {mydata[i,"mother_schooling"] <- mydata$schooling[i]}
  else {mydata[i, "mother_schooling"] <- NA}}

for (i in 1:nrow(mydata))
{if(mydata$father[i] & is.na(mydata$female[i]) == FALSE)
  {mydata[i,"father_schooling"] <- mydata$schooling[i]}
  else {mydata[i, "father_schooling"] <- NA}}

for (i in 1:nrow(mydata))
{if(mydata$relationship[i] == "Child" & is.na(mydata$female[i]) == FALSE)
  {mydata[i,"child_schooling"] <- mydata$schooling[i]}
  else {mydata[i, "child_schooling"] <- NA}}






